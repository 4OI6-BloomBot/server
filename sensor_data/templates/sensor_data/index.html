{% extends "base.html" %}
{% load static %}

{% comment %}
    Template for displaying a table of measurements
    TODO: Can probably abstract the list part of the template and extend it for
          each list component in the project
{% endcomment %}

{% block content %}
    {% if measurement_list %}
        <div style="width: 800px;"><canvas id="sensor_chart"></canvas></div>

        <table id="measurement_table" class="table">
            {% comment %} Table headers {% endcomment %}
            <thead>
                <tr>
                    <th scope="col">Device</th>
                    <th scope="col">Sensor Type</th>
                    <th scope="col">Value</th>
                    <th scope="col">Timestamp</th>
                </tr>
            </thead>
      
            {% for measurement in measurement_list %}
                <tr>
                    <td>{{ measurement.device.name }}</td>
                    <td>{{ measurement.sensor.name }}</td>
                    <td>{{ measurement.value }} {{ measurement.sensor.unit }}</td>
                    <td>{{ measurement.datetime }}</td>
                </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>No measurements are available.</p>
    {% endif %}

    {% if sensor_list %}
        {% for sensor in sensor_list %}
            <a href="{% url 'sensor_data:sensor' sensor.pk %}"><button class="btn btn-primary">{{ sensor.name }}</button></a>
        {% endfor %}
    {% endif %}
{% endblock %}

{% block js %}
    {% comment %} CharJS Import {% endcomment %}
    <script src="{% static './chartjs/chart.min.js' %}"></script>

    <script>
        new DataTable("#measurement_table");
    </script>

    <script>
        
        const data = [
          {% for measurement in measurement_list %}
            { 
              device: "{{ measurement.device.name }}",
              time:   "{{ measurement.datetime }}",
              value:  {{ measurement.value }}
            },
          {% endfor %}
        ];


        new Chart(
          document.getElementById('sensor_chart'),
          {
            type: 'line',            
            data: {
              labels: data.map(row => row.year),
              datasets: [
                {% for measurement in device_list %}
                    {% with measurement.device as device %}
                    {
                        label: "{{ device.name }}",
                        data: data
                          .filter(row => row.device === "{{ device.name }}")
                          .map(row => ({
                            x: row.time,
                            y: row.value
                          }))
                    },
                    {% endwith %}
                {% endfor %}
              ]
            }
          }
        );
    </script>
{% endblock %}