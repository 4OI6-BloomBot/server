{% extends "base.html" %}
{% load static %}

{% comment %}
    Template for displaying a table of measurements
    TODO: Can probably abstract the list part of the template and extend it for
          each list component in the project
{% endcomment %}

{% block content %}
    {% comment %} TODO: Don't really need to pass any measurement data to this anymore {% endcomment %}
    {% if measurement_list %} 
        <div style="width: 800px;"><canvas id="sensor_chart"></canvas></div>

        <table id="measurement_table" class="table">
            {% comment %} Table headers {% endcomment %}
            <thead>
                <tr>
                    <th scope="col">Device</th>
                    <th scope="col">Sensor Type</th>
                    <th scope="col">Value</th>
                    <th scope="col">Timestamp</th>
                </tr>
            </thead>
        </table>
    {% else %}
        <p>No measurements are available.</p>
    {% endif %}

    {% if sensor_list %}
        <button class="btn btn-primary" onclick="setSensorID(null)">All</button>
        {% for sensor in sensor_list %}
            <button class="btn btn-primary" onclick="setSensorID({{ sensor.pk }})">{{ sensor.name }}</button>
        {% endfor %}
    {% endif %}
{% endblock %}

{% block js %}
    {% comment %} ChartJS Import {% endcomment %}
    <script src="{% static './lib/chartjs/chart.min.js' %}"></script>

    {% comment %} Import handler for measurement data {% endcomment %}
    <script src="{% static './js/MeasurementDataHandler.js' %}"></script>

    <script>
        {% comment %}
          Declare the table and chart objects
        {% endcomment %}
        table = new DataTable("#measurement_table", {
            columns: [
              { data: "device" },
              { data: "sensor" },
              { data: "value" },
              { data: "datetime" }
            ]
        });

        chart = new Chart(
          document.getElementById('sensor_chart'),
          {
              type: 'line',            
              data: {
                  datasets: []
              }
          }
        );
      

        {% comment %} 
          Update the chart datasets
        {% endcomment %}
        function updateChart() {
            chart.data.datasets = device_data;
            chart.update();
        }


        {% comment %} 
          Function to update the data in the table
          TODO: Shoudn't clear all data each time we add rows. 
        {% endcomment %}
        function updateTable() {
            table.clear();
            table.rows.add(table_data);
            table.draw();
        }

        {% comment %} 
          Setup chart and update data periodically (5 seconds)
        {% endcomment %}
        fetchMeasurements();
        createChart();

        const fetch = setInterval(fetchMeasurements, 5000);

    </script>
{% endblock %}